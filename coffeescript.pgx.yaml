---
+grammar: cafescript
+toprule: program
ANY:
  .rgx: .
HASH:
  .rgx: \#
TERMINATOR:
  +min: 1
  .all:
  - .ref: _
  - +max: 1
    .ref: comment
  - .ref: TERM
  - +max: 1
    .ref: blockComment
_:
  .rgx: whitespace+(blockComment|\r|(BACK\r?\n)+)?*
blockComment:
  .all:
  - .rgx: \#\#\#
  - .rgx: '[^#]'
  - +min: 0
    .any:
    - .rgx: '[^#]'
    - .all:
      - .rgx: \#
      - +max: 1
        .ref: HASH
      - +asr: -1
        .ref: HASH
  - .rgx: \#\#\#
comment:
  .any:
  - .ref: blockComment
  - .ref: singleLineComment
program:
  .all:
  - +max: 1
    .ref: TERMINATOR
  - .ref: _
  - +max: 1
    .ref: toplevelBlock
singleLineComment:
  .all:
  - .rgx: \#
  - +min: 0
    .all:
    - +asr: -1
      .ref: TERM
    - .ref: ANY
toplevelBlock:
  .all:
  - .ref: toplevelStatement
  - +min: 0
    .all:
    - .ref: _
    - .ref: TERMINATOR
    - .ref: _
    - .ref: toplevelStatement
  - +max: 1
    .ref: TERMINATOR
